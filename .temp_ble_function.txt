      setConnectionStatus('üîç Descubriendo servicios...');
      
      // Obtener informaci√≥n completa del dispositivo
      const peripheralInfo = await BleManager.retrieveServices(peripheralId);
      console.log('üìã Informaci√≥n del dispositivo:', peripheralInfo);
      
      // Buscar caracter√≠sticas disponibles
      const characteristics = peripheralInfo.characteristics || [];
      console.log(`‚úÖ Encontradas ${characteristics.length} caracter√≠sticas`);
      
      if (characteristics.length === 0) {
        throw new Error('No se encontraron caracter√≠sticas en el dispositivo');
      }
      
      // Buscar caracter√≠stica WRITE (para enviar la clave)
      const writeChar = characteristics.find(
        (char: any) => char.properties?.Write || char.properties?.WriteWithoutResponse
      );
      
      // Buscar caracter√≠stica READ (para leer los datos)
      const readChar = characteristics.find(
        (char: any) => char.properties?.Read
      );
      
      console.log('üí° Caracter√≠stica Write:', writeChar);
      console.log('üí° Caracter√≠stica Read:', readChar);
      
      if (!writeChar) {
        throw new Error('No se encontr√≥ caracter√≠stica Write en el dispositivo');
      }
      
      if (!readChar) {
        throw new Error('No se encontr√≥ caracter√≠stica Read en el dispositivo');
      }
      
      // Extraer UUIDs
      const writeCharUUID = writeChar.characteristic;
      const writeServiceUUID = writeChar.service;
      const readCharUUID = readChar.characteristic;
      const readServiceUUID = readChar.service;
      
      console.log(`üìù Write: Service=${writeServiceUUID}, Char=${writeCharUUID}`);
      console.log(`üìñ Read: Service=${readServiceUUID}, Char=${readCharUUID}`);
      
      setConnectionStatus('üîê Autenticando...');
      
      // La clave es el _id de la unidad
      const authKey = busData._id;
      console.log(`üîê Enviando clave de autenticaci√≥n: ${authKey}`);
      
      // Convertir clave a bytes
      const authBytes = stringToBytes(authKey);
      
      // Escribir clave de autenticaci√≥n
      await BleManager.write(
        peripheralId,
        writeServiceUUID,
        writeCharUUID,
        authBytes
      );
      
      console.log('‚úÖ Clave enviada');
      setConnectionStatus('üì• Leyendo datos...');
      
      // Esperar un momento para que el dispositivo procese
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      // Leer datos del dispositivo
      const data = await BleManager.read(
        peripheralId,
        readServiceUUID,
        readCharUUID
      );
      
      console.log('üì• Datos recibidos (bytes):', data);
      
      // Convertir bytes a string
      const dataString = bytesToString(data);
      console.log('üì• Datos recibidos (string):', dataString);
      
      // Intentar parsear como JSON
      let parsedData = tryParseJSON(dataString);
      
      // Si no es JSON v√°lido, intentar parsear manualmente
      if (!parsedData) {
        console.log('‚ö†Ô∏è Los datos no son JSON v√°lido, usando como texto');
        parsedData = { raw: dataString };
      }
      
      console.log('‚úÖ Datos parseados:', parsedData);
      
      // Guardar datos
      setBleData(parsedData);
      setConnectionStatus('‚úÖ Datos recibidos');
      setIsConnecting(false);
      
      Alert.alert(
        'Datos Recibidos',
        `Conteo: ${parsedData.conteo || 'N/A'}\\nUnidad ${busData.numero}: ${parsedData[`Unidad_${busData.numero}`] || 'N/A'}`,
        [
          {
            text: 'OK',
            onPress: () => disconnectDevice()
          }
        ]
      );
      
    } catch (error) {
      console.error('‚ùå Error en autenticaci√≥n/lectura:', error);
      Alert.alert('Error', `No se pudieron obtener los datos del dispositivo: ${error instanceof Error ? error.message : 'Error desconocido'}`);
      setConnectionStatus(`‚ùå Error: ${error instanceof Error ? error.message : 'Error desconocido'}`);
      setIsConnecting(false);
    }
